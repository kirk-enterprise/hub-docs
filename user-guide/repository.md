# 3.2 镜像仓库
镜像仓库是docker的registry概念。用户在每个空间下，都可以拥有多个属于这个空间的镜像仓库。仓库下托管了属于这个仓库的多个镜像版本。<br>

根据仓库中镜像的推送方式，可以将仓库分成两类：    
1.**「非持续构建仓库」：**镜像只能通过`docker push`的命令行方式推送到仓库    
2.**「持续构建仓库」：**镜像除了可以通过`docker push`的命令行方式推送到仓库，还可以配置git代码仓库到镜像仓库的CI规则实现镜像的自动构建并推送到库
***

## 3.2.1 属性说明
### 3.2.1.1 非持续构建仓库
非持续构建仓库不能关联git代码仓库实现镜像的自动编译和推送。它的镜像只能通过`docker push`命令行来推送。

![镜像仓库管理主页面](_figures/user-guide/repo-create-unci.jpeg)

**1.仓库名称：**仓库一旦创建完成，「仓库名称」就不能被修改。

!> 命名规则：2-64位的小写字母、数字、分隔符("-"、"_"、".")，分隔符不能为开头或结尾，且不能连续

**2.摘要：**用于简要描述仓库镜像的功能，字数会被限制在100个字符以内。<br>
如果仓库的类型是公开镜像仓库，这段文字会出现在镜像中心的仓库信息中。

![镜像仓库管理主页面](_figures/user-guide/repo-abstract-hub1.jpeg)

**3.详情：**用于填写仓库其他的描述信息，可能是更详细的镜像版本信息，或者是镜像的使用信息等等。<br>
如果仓库的类型是公开镜像仓库，这段文字会出现在镜像中心的仓库信息中。

![镜像仓库管理主页面](_figures/user-guide/repo-detail-hub.jpeg)

**4.镜像类型：**用于选择仓库内镜像的类型标签，包含`数据库`、`服务器`、`编程语言`、`WEB框架`、`操作系统`、`其他`6种。
如果仓库的类型是公开镜像仓库，这段文字会出现在镜像中心的仓库信息中。

![镜像仓库管理主页面](_figures/user-guide/repo-tag-hub.jpeg)

### <span id="jump1">3.2.1.2 持续构建仓库</span>
持续构建仓库有两种推送镜像到仓库的方式。一种是关联git代码仓库实现镜像的自动编译和推送，另一种是通过`docker push`命令行来推送。

![镜像仓库管理主页面](_figures/user-guide/repo-create-ci.jpeg)

**1.仓库名称：**仓库一旦创建完成，「仓库名称」就不能被修改。

!> 命名规则：2-64位的小写字母、数字、分隔符("-"、"_"、".")，分隔符不能为开头或结尾，且不能连续

**2.摘要：**用于简要描述仓库镜像的功能，字数会被限制在100个字符以内。<br>
如果仓库的类型是公开镜像仓库，这段文字会出现在镜像中心的仓库信息中。

![镜像仓库管理主页面](_figures/user-guide/repo-abstract-hub1.jpeg)

**3.详情：**用于填写仓库其他的描述信息，可能是更详细的镜像版本信息，或者是镜像的使用信息等等。<br>
如果仓库的类型是公开镜像仓库，这段文字会出现在镜像中心的仓库信息中。

![镜像仓库管理主页面](_figures/user-guide/repo-detail-hub.jpeg)

**4.镜像类型：**用于选择仓库内镜像的类型标签，包含`数据库`、`服务器`、`编程语言`、`WEB框架`、`操作系统`、`其他`6种。
如果仓库的类型是公开镜像仓库，这段文字会出现在镜像中心的仓库信息中。

![镜像仓库管理主页面](_figures/user-guide/repo-tag-hub.jpeg)

**5.持续构建：**用于开启仓库的持续构建功能。开启后，就可以选择需要关联的git代码仓库。

**6.设置代码源：**用于关联镜像自动构建所需的git代码仓库，每个镜像仓库只能关联一个git代码仓库。<br>
如果之前没有关联过git代码仓库，打开「持续构建」开关后，会先让你「关联github账号」。

![镜像仓库管理主页面](_figures/user-guide/repo-ci-coderepo.jpeg)

成功关联github账号后，再选择github账号下的代码仓库。至此，算是成功将镜像仓库和git代码仓库做了对接。

**7.构建规则：**镜像仓库不限制构建规则的数量，但是所有构建规则都只和「设置代码源」中约定的git代码仓库有关。

?> **类型：**branch或者tag。这个用来筛选当前规则是基于git代码仓库下的branch还是tag做构建。<br>
**名称：**branch名称或者tag名称。其中tag名称可以用通配符定义。<br>
**Dockerfile文件：**branch或者tag下dockerfile文件所在的路径。<br>
**版本号：**编译后，所生成镜像的版本号名称，需要保证填写的名称符合docker镜像的tag命名规则。如果不填，版本号的名称会和选择的branch名或tag名一致。<br>
**版本覆盖：**开关开启时，如果新构建出来的镜像版本号出现同名，会对之前的镜像版本做覆盖。开关关闭时，所有构建出来镜像版本号会被加上后缀，变成`「版本号」-「git commit前7位」`，以保证每次构建出来的镜像版本都被保留。
***

## 3.2.2 如何实现镜像的持续构建
镜像的持续构建，就是通过更新github代码仓库来触发新的代码自动编译成新的镜像版本，并自动推送入库。<br>
操作如下：

#### 关联github账号到平台

**1）点击控制台左边栏的「个人中心」，进入账户信息页面**

**2）点击「关联账号」，关联github账号到平台**

![镜像仓库管理主页面](_figures/user-guide/center-github-account.jpeg)

**3）点击「Authorize kirk-enterperise」，将github的部分操作权限授权给平台**

![镜像仓库管理主页面](_figures/user-guide/user-repo-auth.jpeg)

授权成功后，可以在控制台的「个人中心」看到github账号名。

![镜像仓库管理主页面](_figures/user-guide/repo-github-accout2.jpeg)

#### 创建持续构建仓库

**4）点击控制台左边栏的「镜像仓库」，进入仓库列表页面**

**5）点击「创建新的仓库」，开始创建一个能够做持续构建镜像的仓库**
仓库属性，详见[3.2.1.2 持续构建仓库](#jump1)

#### 触发持续构建

**6）持续构建的触发，都是通过github的webhook实现的。当持续构建规则中监测的branch或者tag出现更新，就会自动触发新的构建。<br>
用户也可以通过点击对应规则后面的「立即构建」，手动触发构建。**

**如何手动触发镜像构建？**<br>
手动触发镜像构建需要进入仓库详情，操作如下：

**1）点击控制台左边栏的「镜像仓库」，进入仓库列表页面**

**2）点击持续构建仓库右侧的「管理」，进入仓库详情**

**3）点击「持续构建」tab，进入持续构建子页面**<br>
在每个自动构建的规则后面都会有一个「立即构建」的操作，点击后就会触发构建。

**如何查看镜像构建的状态？**<br>
查看镜像构建的状态需要进入仓库详情，操作如下：

**1）点击控制台左边栏的「镜像仓库」，进入仓库列表页面**

**2）点击持续构建仓库右侧的「管理」，进入仓库详情**

**3）点击「持续构建」tab，进入持续构建子页面**<br>
在「构建记录」中可以查看每次自动构建的状态，其中镜像构建状态分为三种：构建中、失败、成功。

?>**构建中：**镜像正在编译中<br>
**失败：**镜像编译失败，不会有新的镜像版本被推送到仓库<br>
**成功：**镜像编译成功，新的镜像版本已经被推送到仓库

**如何查看构建成功的镜像？**<br>
查看镜像需要进入仓库详情，操作如下：

**1）点击控制台左边栏的「镜像仓库」，进入仓库列表页面**

**2）点击持续构建仓库右侧的「管理」，进入仓库详情**

**3）点击「镜像版本」tab，进入镜像版本子页面**<br>
这边汇聚了所有通过`docker pull`和持续构建所生成的镜像。
***

## 3.2.3 如何在镜像构建成功后发送通知
镜像构建成功后，往往需要部署到平台上做测试，这就需要一种通知机制，能够在镜像生成后自动触发。控制台为镜像仓库提供了webhook功能，能够在有新的镜像版本推送到仓库后，发送通知到多个目标URL。<br>
操作如下：

**1）点击控制台左边栏的「镜像仓库」，进入仓库列表页面**

**2）点击持续构建仓库右侧的「管理」，进入仓库详情**

**3）点击「Webhook」tab，进入消息通知子页面**

**4）点击「新建」，开始创建一个webhook通知规则**

![创建新的仓库](_figures/user-guide/repo-webhook-create.jpeg)

?> **名称：**webhook通知规则的名称<br>
**URL：**镜像仓库产生新的镜像时，需要通知到的URL地址

**如何查看每次触发webhook通知的记录？**<br>
查看webhook通知记录需要进入仓库详情，操作如下：

**1）点击控制台左边栏的「镜像仓库」，进入仓库列表页面**

**2）点击持续构建仓库右侧的「管理」，进入仓库详情**

**3）点击「Webhook」tab，进入消息通知子页面**

**4）点击webhook规则右侧的「访问记录」，进入访问记录子页面**<br>
在这里可以看到所有触发的历史记录，包含「失败」和「成功」两种状态。

**5）点击记录右侧的「详情」，查看每次hook的详情**<br>
详情包含了请求头、请求体、响应头、响应体。
***

## 3.2.4 如何隐藏镜像仓库
隐藏镜像仓库能够将「我的仓库」中一些暂时不会使用，或者永远不会使用的仓库迁移到一个仓库的隐藏列表，正常使用的时候将不再可见。仓库的隐藏并不会影响到仓库`docker pull`和`docker push`的功能，也不会影响仓库的webhook功能。

!> 镜像仓库隐藏后会影响到仓库的持续构建功能，所有的持续构建规则将失效。想要恢复，必须要先对仓库取消隐藏

?> 如果向一个隐藏中的仓库执行`docker push`命令，该仓库将会被自动取消隐藏

?> 仓库隐藏后，仓库下面的镜像版本将会被自动全部隐藏。之后取消隐藏仓库，仓库下被隐藏的镜像版本不会被自动取消隐藏。<br>

操作如下：

**1）点击控制台左边栏的「镜像仓库」，进入仓库列表页面**

**2）点击持续构建仓库右侧的「管理」，进入仓库详情**

**3）点击仓库详情头部右侧的「隐藏仓库」**

![创建新的仓库](_figures/user-guide/repo-hide.jpeg)
***

## 3.2.5 如何显示被隐藏的镜像仓库
操作如下：

**1）点击控制台左边栏的「镜像仓库」，进入仓库列表页面**

**2）勾选仓库列表顶部右侧的「显示被隐藏的仓库」**

![创建新的仓库](_figures/user-guide/repo-hide-appear.jpeg)
***

## 3.2.6 如何取消隐藏镜像仓库
操作如下：

**1）点击控制台左边栏的「镜像仓库」，进入仓库列表页面**

**2）勾选仓库列表顶部右侧的「显示被隐藏的仓库」，显示所有被隐藏的镜像仓库**

**3）点击被隐藏仓库右侧的「取消隐藏」**

![创建新的仓库](_figures/user-guide/repo-unhide.jpeg)

?> 取消隐藏仓库，仓库下被隐藏的镜像版本不会被自动取消隐藏。